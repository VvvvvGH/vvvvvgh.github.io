import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as n,a as e,d as r,b as o,r as i,o as s}from"./app-CJlMl9Ja.js";const d={};function l(c,t){const p=i("Mermaid");return s(),n("div",null,[t[0]||(t[0]=e("p",null,"官方文档：https://developer.apple.com/documentation/storekit/in-app_purchase/",-1)),t[1]||(t[1]=e("p",null,"IAP 配置流程：https://developer.apple.com/help/app-store-connect/configure-in-app-purchase-settings/overview-for-configuring-in-app-purchases",-1)),t[2]||(t[2]=e("h2",{id:"苹果内购-iap-的四种类型",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#苹果内购-iap-的四种类型"},[e("span",null,"苹果内购(IAP)的四种类型")])],-1)),r(p,{id:"mermaid-9",code:"eJx1kstOwkAYhfc+RV+AGFwbEm4LN8aFuwkLIARJFAiXuAUjUkGCXASBCkENECKIsUCLIC/Tfzp9C6edGpuoTdNu5jtfz0nDCX/8hDv27HD0ciJSlHFXgKscESfcgfPIx9lsDs6FoPyKFzwRZWU1hFp2P5DYdbhj0WT6zB84DfkYbZx1I+2h++vsYSxqC/6c5yyAB5H8GAoj9WNCpo/01u5zBuNMp2K2RCgaOtcZLpkOJIOJSDwVoTlWo1c3/pOhe42ISDT8V4LxcLGSdqRIGfzSx5mhstmq9ZGRQN8wvYHSu94p02SYSewhLNUht4RVU21fam9r7alnyXWzQewIzyRFzmHhGt/xRqgilZR1m2zzWOhhvgH5MswqjDQhPVrCfFmRJjSazDtkMwBhBp1Pi8DDBrQjqIz0pMzQOoNh0lrPdB1aAvNLKDdoCcabKNXMszCuKpsaFkpQ6FMZFnhYDdiIFpmXjW1HWusWNxeWicw2FjXDTGIPkeGFKhTVjoirE1aL/mEwlamMTg6ySD/+2/cFAZY9Sg=="}),t[3]||(t[3]=e("p",null,"此外，每个应用可以创建多达10,000个内购产品，每个内购必须关联一个应用，且可以在多个平台版本(iOS、macOS、tvOS)间共享，但不能跨不同应用共享。实现应用内购需要在你的应用服务器和苹果的服务器之间进行配置，并在App Store Connect中进行设置和管理。",-1)),t[4]||(t[4]=e("h2",{id:"内购接入流程",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#内购接入流程"},[e("span",null,"内购接入流程")])],-1)),r(p,{id:"mermaid-16",code:"eJx9UttOGlEUffcr+AHT8N6YKIja9qm1SZMTH1pLq4kRY0n6OgRBRG4a0FpGZYjAtMWBNlwHkZ+Zvc+Zv+jx7LGZpInzOGvtdfZea33aiX3d3Hq/Hw+sh+cC8ltkcKdB63gjMD+/EFhiWGhA8dyZfBO9MdhlXjYhXxSWtaHYS4oVYsK6F5YB6ZTo3brGmFc9PKTwMAPdXNzbC7yJx/ajgVBsdze6GXdGt24qz6cWjdFAWA0sM7CueKGr+C+344QtKyzCsH8sOhWaguy1SE4Jjyh8hZHqv/dQz0PWgAvT1b7z6wZxVxR3lWGx5Ng3/sXFrCqMHFgG1kbEXVXcNQY3B7yUdjUN2/fYT3DzmPA1hb9gzijL7ZmYlUTJe8Xn0VKQiV4TM0PMJVA/ElrK1TXRTEhnnn/Yf7bwnz1QScu13aQJmbRiPJ0EOR0KMqyNMW85to26zSs597KOuUPInysNOM15o+o+Qig8v//hIINMFSa23xhaYjiBbA1SSax05TPqHy9fY6bk5dFJu6cN9VvKyhi4WZBn8N8TyPzyx7gsn9DNd5uxj1FZBE/WFykpG5Yzu8TaoeikebsJubHM1h92JMic6Uzeg38uePWUmsELHagnlcB69Es8srP9eStOkD/8laDXFLm/Y7ekNSRCdz6W5u3rV4/uY3kga4nnA3+RqByrUqt5hm2D+iSjdUYFclzZjWddfpRBve2MNNEfEotOrJ5goUVx8OwAtYS/VGvSJdU6WY+dKFj1hwKVO7JDVEMy+vAnZH94Gw8bkBr6QNmXh7qejeGuCMUTWW3ZC7w6IMrG3F/PORt9"}),t[5]||(t[5]=o('<p>实现苹果内购(IAP)功能，需要遵循以下详细流程：</p><ol><li><p><strong>接受付费应用协议</strong>：作为开发者，你的账户持有者需要在App Store Connect的商务部分接受付费应用协议。</p></li><li><p><strong>设计你的内购项目</strong>：根据人机界面指南和应用审核指南，确保你的内购体验与应用其余部分协调，并有效展示你的产品。 https://developer.apple.com/app-store/review/guidelines/</p></li><li><p><strong>在App Store Connect中配置内购</strong>：</p><ul><li>创建内购项目，并添加元数据，如产品名称、描述、价格和可用性。 https://developer.apple.com/help/app-store-connect/manage-consumable-and-non-consumable-in-app-purchases/create-in-app-purchases</li><li>生成内购密钥，并设置税务类别，以便苹果能够为客户交易计算适当的税费。</li><li>https://developer.apple.com/help/app-store-connect/configure-in-app-purchase-settings/generate-keys-for-in-app-purchases</li></ul></li><li><p><strong>实现StoreKit</strong>：在Xcode中为你的应用添加内购功能，确保Xcode中的应用程序标识符和产品标识符与App Store Connect中的相匹配。</p></li><li><p><strong>测试你的内购</strong>：使用苹果提供的沙盒测试环境测试内购，该环境允许你使用测试账户进行免费测试。你还可以使用TestFlight或在Xcode中进一步测试你的应用和内购。</p></li><li><p><strong>使用App Store服务器通知</strong>：</p><ul><li>App Store服务器通知提供有关交易状态和内购相关的关键事件的几乎实时更新，例如退款或订阅状态变更、家庭共享访问等。</li><li>https://developer.apple.com/documentation/appstoreservernotifications</li><li>你需要在App Store Connect中输入你的生产和沙盒服务器环境的URL，以利用这些通知。</li><li>https://developer.apple.com/help/app-store-connect/configure-in-app-purchase-settings/enter-server-urls-for-app-store-server-notifications</li></ul></li><li><p><strong>提交内购项目进行审核</strong>：在你将内购发布到App Store之前，必须提交审核。如果你是首次提交内购，你必须与应用的新版本一起提交。在提交之前确保不缺少任何必需信息。监控内购状态，了解你的内购项目是否可用或是否需要你的关注。</p></li><li><p><strong>处理退款</strong> https://developer.apple.com/documentation/storekit/in-app_purchase/original_api_for_in-app_purchase/handling_refund_notifications 用户的退款方式：</p><ul><li>联系 Apple 客户支持</li><li>登录并使用Apple的自助服务工具reportaproblem.apple.com申请退款</li><li>要求其付款方式发行机构退款</li></ul></li></ol><h2 id="客户端购买流程-iap-api" tabindex="-1"><a class="header-anchor" href="#客户端购买流程-iap-api"><span>客户端购买流程（IAP API）</span></a></h2>',3)),r(p,{id:"mermaid-121",code:"eJx9kl9LwlAYxu/7FOeyoIz+gxdBULfd9AnGOtUgt3V27NoFioim5jBDEbRAqXQGpmiQX8b3uH2L5jmT0km7OGy8vz3v+zzvMfBNFKsyPlakSyJFVpD36BKhiqzokkrRka4jyUDQrrNkf/Jmw9CaWM0AdkY1gqfglOcfQQSTW0y4GNdglQykavAkxPjh/bxxeOidYbQVQpCzIdUcD19YqTAp5yH3PoNPNYqRNlXjrCj6YKrHYiZkS5AuLgrzucJoO4Qcu88+7sbDBhTM8ajGTDuou+7jOtHOozI1Vi80El7jHK9szEZ1RhaUq0IMko9OLeDIV9rxPGXzzmff6bbGg84/LaNEvpIMvKrpVNFUY2nbv35ZucuKQnAxyN0Qcl/Tjm0Kfll+oj5pfUMuIyh4SDvtuluKC/mAH77KMNrjhtyYry2ShGRnfrWC/o1hf34iZvVYpj1vcNZAROvP91Vg1cpSjwfeRhvPrmVCIg7twabov8yqHCUEq/REpQq9xhHv1UCumYH7xPRGJmeb+QGrbVp0"}),t[6]||(t[6]=o('<p>详细步骤：</p><ol><li><p>使用交易监听器监听交易状态变化，通过更新来提供应用运行时的最新服务和内容。</p><ul><li><a href="https://developer.apple.com/documentation/storekit/transaction/3851206-updates" target="_blank" rel="noopener noreferrer">监听交易状态变化</a></li></ul></li><li><p>使用产品请求（<a href="https://developer.apple.com/documentation/storekit/product/3851116-products" target="_blank" rel="noopener noreferrer">products(for:)</a> 从 App Store 请求显示在您应用中的产品。</p></li><li><p>使用（<a href="https://developer.apple.com/documentation/storekit/product/3791971-purchase" target="_blank" rel="noopener noreferrer">purchase(options:)</a>）发起购买</p></li><li><p>使用交易功能（<a href="https://developer.apple.com/documentation/storekit/transaction/3851204-currententitlements" target="_blank" rel="noopener noreferrer">currentEntitlements</a>）遍历用户的应用内购买，并解锁已购买的内容和服务。</p></li><li><p>验证从 API 接收到的签名交易和签名订阅状态信息。</p></li></ol><h2 id="云端流程" tabindex="-1"><a class="header-anchor" href="#云端流程"><span>云端流程</span></a></h2><h3 id="应用商店服务器通知" tabindex="-1"><a class="header-anchor" href="#应用商店服务器通知"><span>应用商店服务器通知</span></a></h3><p>App Store Server Notifications https://developer.apple.com/documentation/appstoreservernotifications</p><h3 id="订阅生命周期状态图" tabindex="-1"><a class="header-anchor" href="#订阅生命周期状态图"><span>订阅生命周期状态图</span></a></h3>',6)),r(p,{id:"mermaid-171",code:"eJydlMtKw0AUhvc+RZdR6MalCyHpTOpATEIurSISuhBx4UaL64KXFkqwiBULhVIRBK0VtFi1qC9jbm/hmEnTpJlGMYuQOZnv/8+cc5j9cqm8BXZK23ul3ezB4lwGPxsLm5lsdjljt2/d/pV3eexH/VcYIhsGI3d4GASWMqrOqTkFcRAwSEQaYgWD09fnfwclnoeKoUAA4SoNJgpRhiICEMASIizSd1tm1Xm7ie3OrbBiHhII28kK5BldzissgEHS0yJuv2vVzryWiaVSRIBUFNNkrOGjdXphP9foGqrGarrKsLomkZgBkMpyAgSz03IHr17VdB+agSTPIsEY82mU1X/3Wg273aGBDD5FDhoyVJAUmPuvWDEpvXDu6pb55Jx37GbNB2KF+wHIZwh8vdTtXtcZ3eNIGkbpOa0BpLqEi6Yd1v1vWslGQDHSh7ic+1klVYRrMsKzzBQkQRc1VokOcaxTaUPMcEgQkJjHq5xUgGORBJ9wnXAaxXnS7X+bxyWmRi86L0aQUiQHkmz61aHAcBHYzqSm7o0ESZ97r1Kxex/W9ZHTOMEieF50kSQZ+0PxI1uxIa6Jig/2DYIuNxw="}),t[7]||(t[7]=e("h3",{id:"主要通知类型概览",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#主要通知类型概览"},[e("span",null,"主要通知类型概览")])],-1)),r(p,{id:"mermaid-175",code:"eJyVkstKHEEUhvd5ilrqY1RXnZ4U6anq1GU0qyKQLLIwM4gP0JuBEJEQkkASBVEQBHVEvI+Xp5nu6XkLa+zuskYUcVn/fy7fOXWWvnz9tPSx9wah5W53ZW4O93pIrXSXP6NiYy3/vpX/251k/8ebO/PzLgahcrA9+dsfDVdHV2f3AkLKRIpIFgGtBYQYZ5rhxEbmg9ck+MBao4xaCRwWfEzEkoTxllOJ6IBskmExZTIo3xGJ4Rp7P0zUgZpKRsAyTiRg1XSdyoIaoi0X2sZCWoWTyiwHW+XJ5cxwU8YYs8Rq8Yi1JbErnoJkoiELJTsL/RwKcOq4/RsTAqmus8a/d4tv58WvtdHNRoBD3mLegorG7TiVEPt8kzoG+lCfigUeKk/kK421UQ8EppnUAsdREqw9sChToSfiGKSzKED71WfwEvUky4r92/H6Rd4/rkPcyIY3faqHpUDcCfjutSrB3ZHyKhFcmXaqmeDOem9A6XsnH5zlw4O8fzQa7vkCHfGuIsivs/zHzzLrz/xFs0BY1O4Xg8aBrFwjP5br3A6PdnpXRlYtitPV8vBPbekp1h1qFv4l"}),t[8]||(t[8]=e("h3",{id:"关键事件处理流程",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#关键事件处理流程"},[e("span",null,"关键事件处理流程")])],-1)),r(p,{id:"mermaid-179",code:"eJx9U+Fq01AU/u9T5AX2CkLSpG22LJ1Ni8JlFBHEH4Iggj8aIUVcajUsuHSutrZza10Zts2gRFxo8zKek+QtTO/N8LLB8uPwcc/3nft9l5PnL1+9ffbi6es3Qk1+IGSfSNALoO3jwIHOD+hNU+tbPJrsC1tbDwWpmV5+ThYtdhbP1uA676hM2vRN1oXxVbKcmEKBJHMfVt3U6yWLBfwJIFrF3cn+HQG2XeiMTEFuJhfnOHTz8VchDD+x8bTIVGLUJaNQVSVFNgWFYGThMoy9KbZ/J/Oz9OQDfn+f9lx2CVPIqtyoKrry2BSKBMIg7UY5dTC6RVWe7KnVzeQSgcNjDNr3T64qxbqescsEv4xTz2Jsxsvy5vEtC3+tbxsqlEW9pDBfotYwamKtbpiC2sRzC0cTmLl8/v+6oqhqjVrlJtB2zseTBbg/cfAR5qvs8iwZ93AqVYv1G1lDVg1R0jY5dwie2plPlhD8gySyMzFze0en6LlMI6nt4LHPnj+xL6EzjcNZNoUpadmmct6TKeySOLzImHjo/l332ZIxSc7+esqxdQL2AYxtaA1wdsazaVHoUlYI9pcbL10fnTlcH8WdAK0W4xUZheISh8sc3uGwxuFdDuscpqVCD/ZIEnnQH7INhiMHrj12cYH2H+X9/BfI+/8Azx2MsA=="}),t[9]||(t[9]=o('<h3 id="详细通知类型说明" tabindex="-1"><a class="header-anchor" href="#详细通知类型说明"><span>详细通知类型说明</span></a></h3><table><thead><tr><th>通知类型</th><th>子类型</th><th>描述</th></tr></thead><tbody><tr><td>CONSUMPTION_REQUEST</td><td>空</td><td>通知类型表明客户启动了对消费型应用内购买或自动续订订阅的退款请求，App Store请求您提供消费数据。更多信息请见发送消费信息。</td></tr><tr><td>DID_CHANGE_RENEWAL_PREF</td><td>UPGRADE</td><td>通知类型及其子类型表明用户更改了他们的订阅计划。如果子类型是UPGRADE，用户升级了他们的订阅。升级立即生效，开始一个新的计费周期，用户将获得之前周期未使用部分的比例退款。</td></tr><tr><td></td><td>DOWNGRADE</td><td>如果子类型是DOWNGRADE，用户降级了他们的订阅。降级将在下一个续订日期生效，不影响当前活跃计划。</td></tr><tr><td></td><td>空</td><td>如果子类型为空，用户将他们的续订偏好更改回当前订阅，有效地取消了降级。更多关于订阅级别的信息，请见在组内排序订阅。</td></tr><tr><td>DID_CHANGE_RENEWAL_STATUS</td><td>AUTO_RENEW_ENABLED</td><td>通知类型及其子类型表明用户更改了订阅续订状态。如果子类型是AUTO_RENEW_ENABLED，用户重新启用了订阅自动续订。</td></tr><tr><td></td><td>AUTO_RENEW_DISABLED</td><td>如果子类型是AUTO_RENEW_DISABLED，用户或App Store在用户请求退款后禁用了订阅自动续订。</td></tr><tr><td>DID_FAIL_TO_RENEW</td><td>GRACE_PERIOD</td><td>通知类型及其子类型表明订阅因计费问题未能续订。订阅进入计费重试期。如果子类型是GRACE_PERIOD，继续在宽限期内提供服务。</td></tr><tr><td></td><td>空</td><td>如果子类型为空，订阅不在宽限期内，您可以停止提供订阅服务。向用户说明他们的计费信息可能存在问题。App Store将继续尝试计费60天，或直到用户解决其计费问题或取消订阅，以先到者为准。有关更多信息，请查看减少非自愿订阅流失。</td></tr><tr><td>DID_RENEW</td><td>BILLING_RECOVERY</td><td>通知类型及其子类型表明订阅成功续订。如果子类型是BILLING_RECOVERY，之前未能续订的过期订阅已成功续订。</td></tr><tr><td></td><td>空</td><td>如果子类型为空，活跃订阅已成功自动续订一个新的交易期。为客户提供订阅内容或服务的访问。</td></tr><tr><td>EXPIRED</td><td>VOLUNTARY</td><td>通知类型及其子类型表明订阅已过期。如果子类型是VOLUNTARY，订阅在用户禁用订阅续订后过期。</td></tr><tr><td></td><td>BILLING_RETRY</td><td>如果子类型是BILLING_RETRY，订阅因计费重试期结束而未能成功进行计费交易而过期。</td></tr><tr><td></td><td>PRICE_INCREASE</td><td>如果子类型是PRICE_INCREASE，订阅因用户未同意需要用户同意的价格上涨而过期。</td></tr><tr><td></td><td>PRODUCT_NOT_FOR_SALE</td><td>如果子类型是PRODUCT_NOT_FOR_SALE，订阅因产品在订阅尝试续订时不可购买而过期。</td></tr><tr><td>REFUND</td><td>空</td><td>通知类型表明App Store成功退款了一笔消费型应用内购买、非消费型应用内购买、自动续订订阅或非续订订阅的交易。revocationDate包含退款交易的时间戳。originalTransactionId和productId识别原始交易和产品。revocationReason包含原因。要请求用户的所有退款交易列表，请参见App Store Server API中的获取退款历史。</td></tr></tbody></table><h3 id="app-store-server-api" tabindex="-1"><a class="header-anchor" href="#app-store-server-api"><span>App Store Server API</span></a></h3><p>https://developer.apple.com/documentation/appstoreserverapi/</p><p>官方 SDK，支持 <a href="https://github.com/apple/app-store-server-library-java" target="_blank" rel="noopener noreferrer">Java 版本</a> https://github.com/apple/app-store-server-library-java https://developer.apple.com/documentation/appstoreserverapi/simplifying_your_implementation_by_using_the_app_store_server_library</p><p>查询交易信息 https://developer.apple.com/documentation/appstoreserverapi/get_transaction_info</p><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料"><span>参考资料</span></a></h2><p>https://ouyangrong.com/posts/iOS-In-App-Purchase/</p><p>App Store Server API 实践总结 https://blog.csdn.net/olsQ93038o99S/article/details/125531909</p><p>iOS StoreKit 2 新特性解析 https://juejin.cn/post/7096063372159877150</p>',10))])}const u=a(d,[["render",l]]),g=JSON.parse('{"path":"/posts/2024-05-06-iap-storekit.html","title":"iOS内购","lang":"zh-CN","frontmatter":{"title":"iOS内购","date":"2024-05-06T00:00:00.000Z","category":["苹果","应用内购买","技术开发"],"tag":["IAP","StoreKit","内购配置","订阅管理","服务器通知","交易处理","退款流程","App Store Connect"],"description":"官方文档：https://developer.apple.com/documentation/storekit/in-app_purchase/ IAP 配置流程：https://developer.apple.com/help/app-store-connect/configure-in-app-purchase-settings/overview-...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"iOS内购\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2024-05-06T00:00:00.000Z\\",\\"dateModified\\":\\"2025-05-29T14:36:19.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Guohao\\",\\"url\\":\\"https://space.vistazx1.top\\"}]}"],["meta",{"property":"og:url","content":"https://space.vistazx1.top/posts/2024-05-06-iap-storekit.html"}],["meta",{"property":"og:site_name","content":"Vista"}],["meta",{"property":"og:title","content":"iOS内购"}],["meta",{"property":"og:description","content":"官方文档：https://developer.apple.com/documentation/storekit/in-app_purchase/ IAP 配置流程：https://developer.apple.com/help/app-store-connect/configure-in-app-purchase-settings/overview-..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-05-29T14:36:19.000Z"}],["meta",{"property":"article:tag","content":"App Store Connect"}],["meta",{"property":"article:tag","content":"退款流程"}],["meta",{"property":"article:tag","content":"交易处理"}],["meta",{"property":"article:tag","content":"服务器通知"}],["meta",{"property":"article:tag","content":"订阅管理"}],["meta",{"property":"article:tag","content":"内购配置"}],["meta",{"property":"article:tag","content":"StoreKit"}],["meta",{"property":"article:tag","content":"IAP"}],["meta",{"property":"article:published_time","content":"2024-05-06T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-05-29T14:36:19.000Z"}]]},"git":{"createdTime":1727623300000,"updatedTime":1748529379000,"contributors":[{"name":"root","username":"root","email":"root@vistazx1.top","commits":1,"url":"https://github.com/root"},{"name":"VvvvvGH","username":"VvvvvGH","email":"cheng123xp@gmail.com","commits":1,"url":"https://github.com/VvvvvGH"}]},"readingTime":{"minutes":9.55,"words":2864},"filePathRelative":"posts/2024-05-06-iap-storekit.md","excerpt":"<p>官方文档：https://developer.apple.com/documentation/storekit/in-app_purchase/</p>\\n<p>IAP 配置流程：https://developer.apple.com/help/app-store-connect/configure-in-app-purchase-settings/overview-for-configuring-in-app-purchases</p>\\n<h2>苹果内购(IAP)的四种类型</h2>\\n<p>此外，每个应用可以创建多达10,000个内购产品，每个内购必须关联一个应用，且可以在多个平台版本(iOS、macOS、tvOS)间共享，但不能跨不同应用共享。实现应用内购需要在你的应用服务器和苹果的服务器之间进行配置，并在App Store Connect中进行设置和管理。</p>","autoDesc":true}');export{u as comp,g as data};
